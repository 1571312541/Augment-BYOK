name: sync-upstream-fork

on:
  schedule:
    # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ (UTC æ—¶é—´ 0, 6, 12, 18 ç‚¹)
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      sync_mode:
        description: "åŒæ­¥æ¨¡å¼"
        required: true
        default: "pr"
        type: choice
        options:
          - pr        # åˆ›å»º PR ä¾›å®¡æ ¸
          - direct    # ç›´æŽ¥åˆå¹¶åˆ° main (è°¨æ…Žä½¿ç”¨)

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/AnkRoot/Augment-BYOK.git || true
          git fetch upstream --prune

      - name: Check for updates
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          LOCAL_SHA=$(git rev-parse origin/main)

          echo "upstream_sha=$UPSTREAM_SHA" >> "$GITHUB_OUTPUT"
          echo "local_sha=$LOCAL_SHA" >> "$GITHUB_OUTPUT"

          if [ "$UPSTREAM_SHA" = "$LOCAL_SHA" ]; then
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "âœ… Already up to date with upstream"
          else
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            COMMIT_COUNT=$(git rev-list --count origin/main..upstream/main)
            echo "commit_count=$COMMIT_COUNT" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Found $COMMIT_COUNT new commit(s) from upstream"
          fi

      - name: Get upstream commit info
        if: steps.check.outputs.has_updates == 'true'
        id: commits
        run: |
          echo "## ä¸Šæ¸¸æ–°æäº¤" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          git log --oneline origin/main..upstream/main | head -20 >> "$GITHUB_STEP_SUMMARY"

          # èŽ·å–æœ€æ–°æäº¤ä¿¡æ¯ç”¨äºŽ PR
          LATEST_MSG=$(git log -1 --format="%s" upstream/main)
          echo "latest_message=$LATEST_MSG" >> "$GITHUB_OUTPUT"

      - name: Create sync branch
        if: steps.check.outputs.has_updates == 'true'
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§åˆ†æ”¯
          git push origin --delete ci/sync-upstream 2>/dev/null || true

          # åŸºäºŽ upstream/main åˆ›å»ºåŒæ­¥åˆ†æ”¯
          git checkout -b ci/sync-upstream upstream/main
          git push -u origin ci/sync-upstream

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true' && (github.event.inputs.sync_mode == 'pr' || github.event.inputs.sync_mode == '')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/sync-upstream
          base: main
          title: "chore: sync upstream (${{ steps.check.outputs.commit_count }} commits)"
          body: |
            ## ðŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“

            **ä¸Šæ¸¸ä»“åº“**: [AnkRoot/Augment-BYOK](https://github.com/AnkRoot/Augment-BYOK)

            ### å˜æ›´æ¦‚è§ˆ
            - **æ–°æäº¤æ•°**: ${{ steps.check.outputs.commit_count }}
            - **ä¸Šæ¸¸ SHA**: `${{ steps.check.outputs.upstream_sha }}`
            - **æœ¬åœ° SHA**: `${{ steps.check.outputs.local_sha }}`

            ### æœ€è¿‘æäº¤
            ```
            ${{ steps.commits.outputs.latest_message }}
            ```

            ---
            âš ï¸ **è¯·åœ¨åˆå¹¶å‰æ£€æŸ¥æ˜¯å¦æœ‰å†²çªæˆ–ç ´åæ€§å˜æ›´**

            _æ­¤ PR ç”± `sync-upstream-fork` å·¥ä½œæµè‡ªåŠ¨åˆ›å»º_
          labels: |
            sync
            automated
          delete-branch: false

      - name: Direct merge (if requested)
        if: steps.check.outputs.has_updates == 'true' && github.event.inputs.sync_mode == 'direct'
        run: |
          git checkout main
          git merge upstream/main --no-edit
          git push origin main
          echo "âœ… å·²ç›´æŽ¥åˆå¹¶ä¸Šæ¸¸å˜æ›´åˆ° main" >> "$GITHUB_STEP_SUMMARY"

      - name: Summary
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.check.outputs.has_updates }}" = "true" ]; then
            echo "ðŸ”„ åŒæ­¥æ“ä½œå·²å®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âœ… æ— éœ€åŒæ­¥ï¼Œå·²æ˜¯æœ€æ–°" >> "$GITHUB_STEP_SUMMARY"
          fi
